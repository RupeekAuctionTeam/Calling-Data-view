<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Portal</title>
<style>
  body { font-family: Verdana, sans-serif; margin: 0; background: #f0f4f9; }
  header { background: #1976d2; color: white; padding: 1px 5px; display: flex; justify-content: space-between; align-items: center; }
  h2 { margin: 0; }

  /* Redesigned Login Box */
  #loginBox {
    margin: 100px auto;
    width: 300px;
    padding: 30px 25px;
    border-radius: 15px;
    background: #ffffff;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    text-align: center;
  }
  #loginBox h3 {
    margin-bottom: 20px;
    color: #1976d2;
    font-size: 20px;
    font-weight: bold;
  }
  #loginBox input {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 14px;
  }
  #loginBox button {
    width: 100%;
    padding: 10px;
    margin-top: 15px;
    border: none;
    border-radius: 8px;
    background: #1976d2;
    color: white;
    font-size: 15px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s;
  }
  #loginBox button:hover { background: #1256a3; }
  #loginMsg {
    margin-top: 10px;
    color: red;
    font-size: 13px;
  }

  #logoutBtn { background: #e53935; color: white; border: none; padding: 1px 5px; border-radius: 5px; cursor: pointer; width: 80px; align: top; font-size: 13px;  }

 #dataBox { padding: .5px; display: none;}
  table { border-collapse: collapse; margin-top: 1px; font-size: 9px; table-layout: auto; width: 100%; }
  th, td { border: 1px solid #050505; padding: .5px .5px; text-align: left; white-space: nowrap; vertical-align: top; }
  th { background: #1976d2; color: white; position: sticky; top: 0; z-index: 2; }
  tr:nth-child(even) { background: #f2f2f2; }
  .filter-row th { background: #f1f1f1; top: 10px; z-index: 1; }
  .filter-row input { width: 95%; font-size: 9px; padding: 1px; }
  .update-fields { display: flex; flex-direction: column; gap: 2px; }
  .update-btn { background: #43a047; color: white; border: none; padding: 3px 6px; border-radius: 4px; cursor: pointer; font-size: 9px; margin-top: 2px; }
  .hidden-col { display: none; }
  .toggle-btn { background: #555; color: white; border: none; padding: 4px 6px; margin-bottom: 1px; cursor: pointer; border-radius: 4px; font-size: 13px; }
</style>
</head>
<body>
<header>
 
  <button class="toggle-btn" onclick="toggleExtra()">Show More Details</button> <button id="logoutBtn" style="display:none;" onclick="logout()">Logout</button>
</header>

<div id="loginBox">
  <h3>üîê Agent Login</h3>
  <input type="text" id="username" placeholder="Enter TC Name">
  <input type="password" id="password" placeholder="Enter Password">
  <button onclick="login()">Login</button>
  <p id="loginMsg"></p>
</div>

<div id="dataBox">
  <div style="overflow-x:auto; max-height:500px;">
    <table id="dataTable"></table>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbw3j-HCB6-O74r0myrv7n_mP5TuNzPERdzYVjklKNpQ8K7CvJ1I1Rvb2SWZqB1s_lrH/exec"; // replace with your Apps Script URL
let currentUser = "";
let hiddenCols = ["Nominee Name", "Nominee Number", "CIBIL Number", "TC Name","Loan Date"];

// On load
window.onload = function() {
  const storedUser = localStorage.getItem("currentUser");
  if(storedUser) {
    currentUser = storedUser;
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("dataBox").style.display = "block";
    document.getElementById("logoutBtn").style.display = "inline-block";
    loadData();
  }
};

function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  const now = new Date();
  const h = now.getHours();
  if(h >= 23 || h < 7) { document.getElementById("loginMsg").innerText = "‚õî Login allowed only 7AM‚Äì8PM"; return; }

  fetch(API_URL, { method:"POST", body: JSON.stringify({action:"login", username, password}) })
  .then(res=>res.json())
  .then(data=>{
    if(data.status==="success"){
      currentUser=username;
      localStorage.setItem("currentUser", username);
      document.getElementById("loginBox").style.display="none";
      document.getElementById("dataBox").style.display="block";
      document.getElementById("logoutBtn").style.display="inline-block";
      loadData();
    } else { document.getElementById("loginMsg").innerText=data.message; }
  });
}

function logout(msg="You have been logged out.") {
  currentUser=""; localStorage.clear();
  document.getElementById("dataBox").style.display="none";
  document.getElementById("loginBox").style.display="block";
  document.getElementById("logoutBtn").style.display="none";
  document.getElementById("loginMsg").innerText=msg;
}

function formatDate(d, colName="") {
  if(!d) return "";
  const date = new Date(d);
  if(isNaN(date)) return d;
  const mm = ("0" + (date.getMonth()+1)).slice(-2);
  const dd = ("0" + date.getDate()).slice(-2);
  const yyyy = date.getFullYear();
  if(colName==="Loan Date" || colName==="Expiry Date"){ return `${mm}-${dd}-${yyyy}`; }
  return d;
}

function loadData() {
  fetch(API_URL, { method:"POST", body: JSON.stringify({action:"getData", username: currentUser}) })
  .then(res=>res.json())
  .then(data=>{
    if(data.status==="success") { renderTable(data.headers, data.rows); }
  });
}

function renderTable(headers, rows) {
  const table=document.getElementById("dataTable");
  table.innerHTML="";
  headers=headers.filter(h=>h!=="TC Name");

  let tr=document.createElement("tr");
  headers.forEach(h=>{
    let th=document.createElement("th"); th.textContent=h;
    if(hiddenCols.includes(h)) th.classList.add("hidden-col");
    tr.appendChild(th);
  });
  tr.appendChild(document.createElement("th")); // Follow-up/Closure column
  table.appendChild(tr);

  let filterRow=document.createElement("tr");
  filterRow.classList.add("filter-row");
  headers.forEach(h=>{
    let th=document.createElement("th");
    let inp=document.createElement("input");
    inp.placeholder="Filter";
    inp.oninput=function(){ applyFilters(); };
    th.appendChild(inp);
    if(hiddenCols.includes(h)) th.classList.add("hidden-col");
    filterRow.appendChild(th);
  });
  filterRow.appendChild(document.createElement("th"));
  table.appendChild(filterRow);

  rows.forEach(row=>{
    let tr=document.createElement("tr");
    headers.forEach((h,i)=>{
      let td=document.createElement("td");
      if(row[i] && !isNaN(Date.parse(row[i]))){ td.textContent=formatDate(row[i], h); }
      else { td.textContent=row[i]; }
      if(hiddenCols.includes(h)) td.classList.add("hidden-col");
      tr.appendChild(td);
    });

    let actionTd=document.createElement("td");
    actionTd.appendChild(buildFollowupForm(row, headers));
    tr.appendChild(actionTd);
    table.appendChild(tr);
  });
}

function toggleExtra(){
  document.querySelectorAll(".hidden-col").forEach(el=>{
    el.style.display=(el.style.display==="none"||el.style.display==="")?"table-cell":"none";
  });
}

function buildFollowupForm(row, headers){
  const wrapper=document.createElement("div"); wrapper.classList.add("update-fields");

  const typeSel=document.createElement("select");
  typeSel.innerHTML=`<option value="">--Select--</option><option value="Closure">Closure</option><option value="Follow-up">Follow-up</option>`;
  wrapper.appendChild(typeSel);

  const dynamicDiv=document.createElement("div"); wrapper.appendChild(dynamicDiv);

  const saveBtn=document.createElement("button"); saveBtn.className="update-btn"; saveBtn.textContent="Submit";
  wrapper.appendChild(saveBtn);

  typeSel.onchange=function(){
    dynamicDiv.innerHTML="";
    if(typeSel.value==="Closure"){
      const closureSel=document.createElement("select");
      closureSel.innerHTML=`<option value="">--Select Closure Type--</option>
        <option>Renewed</option><option>Released</option><option>ITO Booked</option>
        <option>RnRP Booked</option><option>Released and Rebook</option>
        <option>MIP -interest cleared</option><option>ITO Completed</option>
        <option>Post Auction Payment</option>`;
      dynamicDiv.appendChild(closureSel);

      closureSel.onchange=function(){
        dynamicDiv.querySelectorAll("input, select:not(:first-child)").forEach(el=>el.remove()); // clear old inputs

        if(this.value==="Released and Rebook"){
          const rebook=document.createElement("input"); rebook.type="number"; rebook.placeholder="New Rebook Sec GL ID";
          dynamicDiv.appendChild(rebook);
        } else if(this.value==="Post Auction Payment"){
          const amtInput=document.createElement("input"); amtInput.type="number"; amtInput.placeholder="Unsec Collected Amount";
          const fileInput=document.createElement("input"); fileInput.type="file"; fileInput.accept="image/*";
          const dateInput=document.createElement("input"); dateInput.type="date";
          const modeSel=document.createElement("select");
          modeSel.innerHTML=`<option>Cash Deposit At Branch</option><option>Online</option>`;
          dynamicDiv.append(amtInput, fileInput, dateInput, modeSel);
        }
      };
    } else if(typeSel.value==="Follow-up"){
      const dispSel=document.createElement("select");
      dispSel.innerHTML=`<option value="">--Select Disposition--</option>
        <option>Promise to Pay Renewal</option><option>Promise to Pay Release</option>
        <option>Promise to Pay ITO</option><option>Promise to Pay RNRP Offline</option>
        <option>Promise to Pay RNRP Online</option><option>Promise to Pay MIP interest</option>
        <option>Paid for ITO Awaiting for Slot</option><option>Paid for RNRP Awaiting for Slot</option>
        <option>PTP But Not Confirm Date</option><option>UT A/C Cx Will Clear by Tenure End</option>
        <option>Call Back. Request</option><option>Left Message</option>
        <option>Broken Promise to Pay</option><option>Escalation Case</option>
        <option>Medical Issue</option><option>Abuse Cx</option>
        <option>Direct Fed NPA</option><option>Intent To Auction</option>
        <option>Refuse to Pay</option><option>Wrong Number</option>
        <option>Call Drop</option><option>Invalid Number</option>
        <option>Not reachable</option><option>Ringing No Response</option>
        <option>Switched-off</option><option>No NPA At Branch(Mail Confirmed)</option>
        <option>No NPA At Branch(Customer Will Visit branch)</option><option>Legal Case</option>
        <option>Customer Deceased</option><option>Renewed</option><option>Released</option>
        <option>ITO Booked</option><option>RNRP Online Booked</option><option>RNRP Offline Booked</option>
        <option>MIP interest cleared</option><option>ITO Completed</option><option>RNRP Completed</option>
        <option>Pay Within Week.</option><option>Promise to Pay Rebook</option>
        <option>Promise to Pay RNRP</option><option>Tech Issue</option>
        <option>Promise to Pay for Direct NPA Case</option>
        <option>Customer Cleared Direct NPA Case</option>`;
      dynamicDiv.appendChild(dispSel);

      const remark=document.createElement("input"); remark.placeholder="Remarks"; dynamicDiv.appendChild(remark);
      const ptp=document.createElement("input"); ptp.type="date"; ptp.style.display="none"; dynamicDiv.appendChild(ptp);

      dispSel.onchange=function(){
        const ptpNeeded=["Promise to Pay Renewal","Promise to Pay Release","Promise to Pay ITO","Promise to Pay RNRP Offline","Promise to Pay RNRP Online","Promise to Pay MIP interest"];
        ptp.style.display=ptpNeeded.includes(this.value)?"block":"none";
      };
    }
  };

  saveBtn.onclick=function(){
  const secGlId=row[headers.indexOf("Sec Gl Id")];
  const payload={ action:"updateRow", user:currentUser, secGlId, followupType:typeSel.value };

  if(typeSel.value==="Closure"){
    const closureSel=dynamicDiv.querySelector("select");
    payload.closureType=closureSel?closureSel.value:"";

    if(closureSel && closureSel.value==="Released and Rebook"){
      payload.rebookId=dynamicDiv.querySelector("input[type=number]")?.value || "";
      sendUpdate(payload, true); // disable only for closure
    } else if(closureSel && closureSel.value==="Post Auction Payment"){
      const fileInput=dynamicDiv.querySelector("input[type=file]");
      const amtInput=dynamicDiv.querySelector("input[type=number]");
      const dateInput=dynamicDiv.querySelector("input[type=date]");
      const modeSel=dynamicDiv.querySelector("select");

      if(fileInput.files[0]){
        const reader = new FileReader();
        reader.onload = function(e){
          payload.paymentScreenshot = e.target.result.split(",")[1]; // Base64
          payload.unsecAmt = amtInput.value;
          payload.payDate = dateInput.value;
          payload.mode = modeSel.value;
          sendUpdate(payload, true); // disable only for closure
        };
        reader.readAsDataURL(fileInput.files[0]);
      } else {
        payload.paymentScreenshot = "";
        payload.unsecAmt = amtInput.value;
        payload.payDate = dateInput.value;
        payload.mode = modeSel.value;
        sendUpdate(payload, true); // disable only for closure
      }
    } else sendUpdate(payload, true);
  } else if(typeSel.value==="Follow-up"){
    payload.disposition=dynamicDiv.querySelector("select")?.value || "";
    payload.remarks=dynamicDiv.querySelector("input[placeholder=Remarks]")?.value || "";
    payload.ptpDate=dynamicDiv.querySelector("input[type=date]")?.value || "";
    sendUpdate(payload, false); // do not disable inputs for follow-up
  }
};

function sendUpdate(payload, disableInputs){
  fetch(API_URL,{ method:"POST", body: JSON.stringify(payload)})
  .then(r=>r.json()).then(res=>{
    alert(res.message);
    if(disableInputs){
      wrapper.querySelectorAll("input, select, button").forEach(el=>el.disabled=true);
    }
  });
}

  return wrapper;
}
</script>
</body>
</html>


